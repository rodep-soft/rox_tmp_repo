# Rox Robot 操作マニュアル

## 🤖 ロボット概要
このドキュメントでは、Roxロボットの操作方法について詳しく説明します。
Roxロボットは**足回り制御**と**上物制御（昇降・射出・押出）**の2つの独立したサブシステムで構成されており、
PlayStation互換コントローラで統合制御します。

---

## 🚗 足回り制御システム

### 制御モード一覧

| モード | LED表示 | 説明 | 特徴 |
|--------|----------|------|------|
| **STOP** | 🔴 赤点灯 | 完全停止モード | すべての移動を停止・安全モード |
| **JOY** | 🟢 緑点灯 | ジョイスティックモード | アナログスティックで自由な移動 |
| **DPAD** | 🔵 青点灯 | 方向パッドモード | デジタル入力 + IMU角度補正 |
| **LINETRACE** | ⚪ 白点灯 | ライントレースモード | 自動ライン追従（足回り無効） |

### モード切り替え方法

#### 基本モード切り替え
- **STOPモード**: `左小ボタン(Share)` - 🔴 赤LED
- **JOYモード**: `右小ボタン(Options)` - 🟢 緑LED  
- **DPADモード**: `L1ボタン` - 🔵 青LED

#### ライントレースモード
- **切り替え**: `左右スティック同時押し込み` - ⚪ 白LED
- **解除**: 再度`左右スティック同時押し込み`（JOYモードに戻る）

> ⚠️ **重要**: 
> - ライントレースモード中は他のモードに切り替えできません
> - ロボット起動時は**STOPモード**（赤LED）で開始されます

### 各モードの操作方法

#### 1. JOYモード（ジョイスティック制御）
```
移動制御:
- 左スティック上下（axes[1]）: 前後移動
- 左スティック左右（axes[0]）: 左右移動
- 右スティック左右（axes[2]）: 回転

特殊機能:
- L2トリガー: 左回転（手動）
- R2トリガー: 右回転（手動）
- PSボタン: 前後反転トグル
```

**デッドゾーン機能**:
- 移動中の回転デッドゾーン: 0.3（ドリフト防止）
- 停止中の回転デッドゾーン: 0.15
- 移動軸デッドゾーン: 0.05

#### 2. DPADモード（方向パッド制御） - 🔵 青LED
```
移動制御:
- 上方向パッド（button[11]）: 前進
- 下方向パッド（button[12]）: 後退  
- 左方向パッド（button[13]）: 左移動
- 右方向パッド（button[14]）: 右移動

自動角度補正:
- IMUセンサーによる自動姿勢制御
- モード開始時の角度を基準に補正
- L2/R2で手動回転時は補正を一時停止
```

⚠️ **使用上の注意**: 
- 感度はJOYモードより低めに設定
- IMU補正機能にバグが残存している可能性があるため、現状では使用非推奨

#### 3. STOPモード - 🔴 赤LED
- すべての移動コマンドを無効化
- 緊急停止・安全確認用
- ロボット起動時のデフォルトモード

#### 4. LINETRACEモード - ⚪ 白LED
- 足回り制御を無効化
- 別のライントレースアルゴリズムが制御を担当
- どのモードからでも左右スティック押し込みで移行可能

### 共通操作
- **前後反転**: `R1`ボタン押下でトグル切り替え
- **手動回転**: L2/R2トリガーで任意モードで手動回転可能

---

## 🎯 上物制御システム

上物制御は**ステートマシン**で管理され、足回りモードに関係なく独立して動作します。

### 上物モード一覧

| モード | 説明 | 操作可能な機能 | 遷移条件 |
|--------|------|----------------|----------|
| **INIT** | 初期化状態 | 昇降のみ | L2+R2でSTOPPEDへ |
| **STOPPED** | 射出準備完了 | 射出のみ | 自動/手動遷移 |
| **TO_MAX** | 押し出し中 | なし（自動制御） | 最大位置でRETURN_TO_MINへ |
| **RETURN_TO_MIN** | 復帰中 | なし（自動制御） | 最小位置でSTOPPEDへ |

### 詳細な状態遷移

#### 🔄 INIT（初期化状態）
```
特徴:
- ロボット起動時の初期状態
- 昇降機構のみ操作可能
- 射出機構は安全のため無効

操作:
- △ボタン: 昇降機構上昇
- ×ボタン: 昇降機構下降
- L2+R2同時押し: STOPPED状態へ遷移
```

#### ✅ STOPPED（射出準備完了）
```
特徴:
- 射出の準備が整った状態
- 射出機能のみ操作可能
- 通常運用時の基本状態

操作:
- ○ボタン: 自動射出シーケンス開始
- L2+R2同時押し: INIT状態へ戻る

制限事項:
- 昇降機構は操作不可（安全のため固定）

自動遷移:
INIT→STOPPEDの際、安全のため昇降機構が自動的に最下位置まで下降
```

#### 🚀 TO_MAX（押し出し中）
```
特徴:
- 射出シーケンス実行中
- 操縦者の介入不可（自動制御）
- リレー駆動により押し出し動作

自動遷移:
- 最大位置リミットスイッチ検出でRETURN_TO_MINへ自動遷移
```

#### 🔄 RETURN_TO_MIN（復帰中）  
```
特徴:
- 射出完了後の自動復帰中
- 操縦者の介入不可（自動制御）
- 次回射出のための準備動作

自動遷移:
- 最小位置リミットスイッチ検出でSTOPPEDへ自動遷移
```

### 🎮 基本操作

#### システム準備・状態遷移
```
L2 + R2 同時押し: INIT ⇄ STOPPED 切り替え
```
> この操作により上物システムの初期化と射出準備が完了します

#### 昇降制御（INITモードでのみ有効）
```
上昇: △ボタン - 押している間上昇
下降: ×ボタン - 押している間下降
停止: ボタンを離す
```

> ⚠️ **重要**: 昇降制御はINITモードでのみ可能です。STOPPEDモードでは安全のため昇降は固定されます。

#### 射出制御（STOPPEDモードで有効）
```
自動射出: ○ボタン
```
> ○ボタンを押すと以下の自動シーケンスが実行されます：
> 1. STOPPED → TO_MAX（押し出し開始）
> 2. TO_MAX → RETURN_TO_MIN（最大位置到達で復帰開始）  
> 3. RETURN_TO_MIN → STOPPED（最小位置到達で準備完了）

#### 手動射出（非推奨・デバッグ用）
```
手動押し出し: □ボタン - 押している間のみ動作
```
> ⚠️ **警告**: この機能は主にデバッグ用です。通常は○ボタンによる自動射出を使用してください

---

## 🎮 コントローラ配置図

### PlayStation コントローラ ボタン配置
```
        L1(4)  L2(axes[4])           R1(5)  R2(axes[5])
          
    左スティック          △(3)    右スティック
    axes[0]: 左右       □(2) ○(1)   axes[2]: 左右回転
    axes[1]: 前後         ×(0)      押し込み: button[9]
    押し込み: button[10]

         Share(7) ◎ Options(6)
                PS(16)

         ↑(11)
     ←(13) ◎ →(14)  
         ↓(12)
```

### 🗺️ 機能マッピング表

| ボタン/軸 | 足回り機能 | 上物機能 | 備考 |
|-----------|------------|----------|------|
| ×ボタン | - | 昇降下降 | INITで有効 |
| ○ボタン | - | **自動射出** | STOPPEDで有効 |
| □ボタン | - | 手動押し出し | デバッグ用 |
| △ボタン | - | 昇降上昇 | INITで有効 |
| L1ボタン | **DPADモード** | - | 🔵 青LED |
| R1ボタン | - | - | 未使用 |
| Optionsボタン | **JOYモード** | - | 🟢 緑LED |
| Shareボタン | **STOPモード** | - | � 赤LED |
| 右スティック押込 | ライントレース※ | - | ⚪ 白LED |
| 左スティック押込 | ライントレース※ | - | ⚪ 白LED |
| 方向パッド上 | DPAD前進 | - | DPADモード時 |
| 方向パッド下 | DPAD後退 | - | DPADモード時 |
| 方向パッド左 | DPAD左移動 | - | DPADモード時 |
| 方向パッド右 | DPAD右移動 | - | DPADモード時 |
| PSボタン | **前後反転** | - | トグル切り替え |
| 左スティック左右 | 左右移動 | - | JOYモード時 |
| 左スティック上下 | 前後移動 | - | JOYモード時 |
| 右スティック左右 | 回転 | - | JOYモード時 |
| L2トリガー | 左回転 | システム準備※ | 手動回転 |
| R2トリガー | 右回転 | システム準備※ | 手動回転 |

※ 同時押し機能

### 🚨 優先度とモード競合

#### 上物制御の優先度
1. **安全リセット** > **緊急停止** > **通常操作**
2. **L2+R2同時押し**は最高優先度でINIT/STOPPED切り替え

#### 足回り制御の優先度
1. **LINETRACEモード**が最高優先度（他モード切替無効）
2. **STOPモード**は緊急時用（いつでも切替可能）

---

## 📋 操作シーケンス例

### 🚀 基本的な操作フロー

#### 1. ロボット起動からの基本セットアップ
```
1. ロボット電源ON
   ├─ 足回り: STOPモード（🔴 赤LED）
   └─ 上物: INITモード

2. 上物初期化
   ├─ L2 + R2同時押し
   ├─ 昇降機構が自動で最下位置へ移動
   └─ 上物: STOPPEDモード（射出準備完了）

3. 足回り操作開始
   ├─ 右小ボタン(Options)押下
   └─ 足回り: JOYモード（🟢 緑LED）

4. 移動開始
   └─ 左スティックで移動、右スティックで回転
```

#### 2. 射出シーケンス
```
前提条件: 上物がSTOPPEDモード

1. 射出位置への移動
   ├─ JOYモードで目標位置まで移動
   └─ 必要に応じて昇降調整（△/×ボタン）

2. 射出実行
   ├─ ○ボタン押下
   ├─ 自動シーケンス開始
   │   ├─ STOPPED → TO_MAX（押し出し）
   │   ├─ TO_MAX → RETURN_TO_MIN（復帰）
   │   └─ RETURN_TO_MIN → STOPPED（完了）
   └─ 約5-10秒で自動完了

3. 次回射出準備
   └─ 自動的にSTOPPEDモードに戻る
```

#### 3. ライントレース操作
```
1. ライントレース開始
   ├─ 左右スティック同時押し込み
   ├─ 足回り: LINETRACEモード（⚪ 白LED）
   └─ 自動ライン追従開始

2. ライン追従中
   ├─ 足回り操作無効（自動制御）
   └─ 上物操作は引き続き可能

3. 手動復帰
   ├─ 左右スティック同時押し込み
   └─ 足回り: JOYモード（🟢 緑LED）
```

### 🚨 緊急時対応

#### 緊急停止手順
```
1. 足回り緊急停止
   ├─ 左小ボタン(Share)押下
   └─ STOPモード（🔴 赤LED）- すべての移動停止

2. 上物リセット
   ├─ L2 + R2同時押し
   └─ INITモードへ強制復帰
```

#### 異常時の復帰手順
```
状況: 上物が中途半端な状態で停止

1. 強制初期化
   ├─ L2 + R2でINITモードへ
   ├─ △/×ボタンで手動位置調整
   └─ 再度L2 + R2でSTOPPEDモードへ

2. 足回りリセット
   ├─ 左小ボタン(Share)で一旦STOP
   └─ 右小ボタン(Options)で通常操作に復帰
```

---

## 🔧 トラブルシューティング

### よくある問題と解決方法

#### 🔄 足回り関連

| 問題 | 症状 | 原因 | 解決方法 |
|------|------|------|----------|
| **勝手に回転** | 前進時に左右に曲がる | ジョイスティックドリフト | JOYモードの動的デッドゾーンが自動対応済み |
| **真っ直ぐ進まない** | DPADで斜めに移動 | IMU角度補正の基準ズレ | DPADモード再選択で基準値リセット |
| **動かない** | スティック操作無効 | STOPモード or LINETRACE | LEDを確認してモード切替 |
| **反応が悪い** | 操作に遅延 | デッドゾーン設定 | より大きな入力で操作 |

#### 🎯 上物関連

| 問題 | 症状 | 原因 | 解決方法 |
|------|------|------|----------|
| **射出しない** | ○ボタン無効 | INIT状態またはシーケンス中 | L2+R2でSTOPPED状態に遷移 |
| **昇降しない** | △/×ボタン無効 | TO_MAX/RETURN_TO_MIN状態 | 自動シーケンス完了まで待機 |
| **途中で停止** | シーケンス中断 | リミットスイッチ故障 | L2+R2でINIT強制復帰 |
| **位置がズレ** | 昇降位置不正 | 位置センサー誤動作 | 手動調整後にシステム再起動 |

#### 🔗 システム全般

| 問題 | 症状 | 原因 | 解決方法 |
|------|------|------|----------|
| **操作受付なし** | 全ボタン無効 | コントローラ接続切れ | コントローラ再接続 |
| **LED点灯なし** | 状態表示なし | LED制御ノード停止 | システム再起動 |
| **予期しない動作** | モード切替不能 | ノード間通信エラー | ROS2システム再起動 |

### 🔍 デバッグコマンド

#### システム状態確認
```bash
# 現在のモード確認
ros2 topic echo /mode

# ジョイスティック入力確認  
ros2 topic echo /joy

# 移動コマンド確認
ros2 topic echo /cmd_vel

# 上物制御確認
ros2 topic echo /upper_motor

# 上物状態確認
ros2 topic echo /lifting_mode
```

#### ログ確認
```bash
# joy_driverノードのログ
ros2 run joy_driver joy_driver_node --ros-args --log-level debug

# lifting_motorノードのログ  
ros2 run lifting_motor lifting_motor_node --ros-args --log-level info

# システム全体のトピック一覧
ros2 topic list

# ノード接続状況
ros2 node list
```

### ⚡ クイック診断チェックリスト

#### 起動時確認事項
- [ ] LEDが赤色点灯（STOPモード）
- [ ] コントローラのPSボタンが点灯
- [ ] ROS2ノードが全て起動済み
- [ ] L2+R2で上物がSTOPPEDモードに遷移

#### 動作前確認事項  
- [ ] 適切な動作モードに切替済み
- [ ] LEDが目的のモード色で点灯
- [ ] 上物がSTOPPEDモード（射出時）
- [ ] 周囲安全確認完了

#### 異常時確認事項
- [ ] 左小ボタン(Share)で緊急停止実行
- [ ] L2+R2で上物強制初期化実行
- [ ] システム再起動検討
- [ ] ハードウェア目視点検

---

## ⚙️ 技術仕様詳細

### 🔧 システムアーキテクチャ

#### ROS2ノード構成
```
joy_driver_node
├─ 入力: /joy (sensor_msgs/Joy)
├─ 出力: /cmd_vel (geometry_msgs/Twist)
├─ 出力: /upper_motor (custom_interfaces/UpperMotor)
├─ 出力: /mode (std_msgs/String)
└─ 出力: /is_linetrace (std_msgs/Bool)

mecanum_wheel_controller_node  
├─ 入力: /cmd_vel (geometry_msgs/Twist)
└─ 出力: モーター制御信号（シリアル通信）

lifting_motor_node
├─ 入力: /upper_motor (custom_interfaces/UpperMotor)
├─ 出力: /lifting_mode (std_msgs/String)
└─ 出力: モーター制御信号（GPIO/リレー）

led_control_node
├─ 入力: /mode (std_msgs/String)
└─ 出力: LED制御信号（GPIO）
```

#### 制御パラメータ設定
```yaml
# config/config.yaml
joy_driver:
  linear_x_scale: 1.0      # 前後移動速度倍率
  linear_y_scale: 1.0      # 左右移動速度倍率  
  angular_scale: 1.0       # 回転速度倍率
  linear_x_axis: 1         # 前後軸番号
  linear_y_axis: 0         # 左右軸番号
  angular_axis: 2          # 回転軸番号
  
  # DPAD角度補正パラメータ
  Kp: 0.3                  # 角度補正比例ゲイン
  deadband: 0.05           # 角度補正デッドバンド（rad）
  max_angular_correction: 0.5  # 最大角度補正速度

  # デッドゾーン設定
  deadzone_moving: 0.3     # 移動中の回転デッドゾーン
  deadzone_stationary: 0.15 # 停止中の回転デッドゾーン
  deadzone_linear: 0.05    # 移動軸デッドゾーン
```

### 📡 通信プロトコル

#### ジョイスティック入力フォーマット
```cpp
sensor_msgs::msg::Joy {
  std_msgs::Header header
  float32[] axes      // [L_LR, L_UD, R_LR, -, L2, R2, ...]
  int32[] buttons     // [X, O, □, △, L1, R1, ...]
}
```

#### 上物制御メッセージ
```cpp
custom_interfaces::msg::UpperMotor {
  bool is_system_ready     // L2+R2同時押し状態
  bool is_throwing_on      // 手動押し出し(□ボタン)
  bool is_ejection_on      // 自動射出(○ボタン) 
  uint8 elevation_mode     // 0:下降, 1:上昇, 2:停止
}
```

### 🔌 ハードウェア接続

#### 足回りモーター（メカナムホイール）
- **通信方式**: RS485シリアル通信
- **モーター型番**: DDSM115
- **制御方式**: RPM指令 + CRC8チェックサム
- **接続**: USB-Serialコンバータ経由

#### 上物機構
- **昇降モーター**: ステッピングモーター + リミットスイッチ
- **射出機構**: リレー駆動 + 押し出しアクチュエータ
- **センサー**: 最大/最小位置リミットスイッチ
- **接続**: GPIOピン直接制御

#### LED表示システム  
- **タイプ**: NeoPixel互換RGB LED
- **制御**: SPI通信
- **表示パターン**: 各モード専用スクリプト

### 📊 性能仕様

#### 制御周期
- **ジョイスティック入力**: ~100Hz
- **足回り制御出力**: 入力同期（~100Hz）
- **上物制御出力**: 入力同期（~100Hz）
- **状態更新**: 入力同期（~100Hz）

#### レスポンス性能
- **モード切替**: <100ms
- **移動コマンド**: <10ms
- **射出シーケンス**: 5-10秒（自動）
- **緊急停止**: <50ms

#### 移動性能
- **最大速度**: 設定可能（パラメータ調整）
- **回転性能**: 360度自由回転
- **移動方式**: オムニディレクショナル（全方向）
- **精度**: ±5度（IMU補正あり）

### 🛡️ 安全機能

#### フェイルセーフ機能
1. **通信断**: コマンド受信停止時の自動停止
2. **デッドマンスイッチ**: コントローラ離脱時の緊急停止
3. **リミットスイッチ**: 上物機構の物理的制限
4. **ウォッチドッグ**: システム応答監視

#### 冗長性設計
- **複数停止方法**: 左小ボタン(Share)/緊急停止/通信断
- **状態確認**: LED + ROS2トピック
- **手動復帰**: 全自動シーケンスに手動介入可能

---

## 📚 付録

### A. ROS2コマンドリファレンス

#### システム制御
```bash
# ノード起動
ros2 run joy_driver joy_driver_node
ros2 run mecanum_wheel_controller mecanum_wheel_controller_node  
ros2 run lifting_motor lifting_motor_node
ros2 run led_control led_control_node

# パラメータ設定
ros2 param set /joy_driver_node linear_x_scale 1.5
ros2 param get /joy_driver_node angular_scale

# システム状態確認
ros2 service call /brake std_srvs/srv/SetBool "{data: true}"
```

#### 手動テスト用コマンド
```bash
# 手動移動テスト
ros2 topic pub /cmd_vel geometry_msgs/Twist \
  "{linear: {x: 0.5, y: 0.0, z: 0.0}, angular: {x: 0.0, y: 0.0, z: 0.0}}"

# 手動射出テスト
ros2 topic pub /upper_motor custom_interfaces/UpperMotor \
  "{is_system_ready: true, is_ejection_on: true, elevation_mode: 2}"
```

### B. エラーコード一覧

| コード | 内容 | 対処方法 |
|--------|------|----------|
| ERR_JOY_001 | ジョイスティック軸不足 | コントローラ再接続 |
| ERR_JOY_002 | ボタン数不足 | 対応コントローラ使用 |
| ERR_MOTOR_001 | シリアル通信エラー | ケーブル確認 |
| ERR_LIFT_001 | リミットスイッチエラー | センサー点検 |
| ERR_LED_001 | LED制御エラー | GPIO接続確認 |

### C. メンテナンス情報

#### 定期点検項目
- [ ] コントローラバッテリー残量
- [ ] シリアルケーブル接続状況  
- [ ] リミットスイッチ動作確認
- [ ] LED点灯パターン確認
- [ ] モーター異音チェック

#### キャリブレーション手順
1. IMU角度補正ゼロ点設定
2. リミットスイッチ位置調整
3. デッドゾーン値最適化
4. モーター出力調整

---

**** Support
- 対応ROS2: Humble
